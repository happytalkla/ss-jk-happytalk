<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="auth">

	<select id="selectAuth" resultType="CMap">
		/* auth.selectAuth */
		select *
		from shfda.tb_auth
		<where>
			<if test="authId != null">
			and auth_id = #{authId}
			</if>
			<if test="cstmUid != null">
			and cstm_uid = #{cstmUid}
			</if>
			<if test="cocId != null">
			and coc_id = #{cocId}
			</if>
			<if test="chatRoomUid != null">
			and chat_room_uid = #{chatRoomUid}
			</if>
			<if test="authType != null">
			and auth_type = #{authType}
			</if>
			<if test="authPosition != null">
			and auth_position = #{authPosition}
			</if>
			<if test="expiredMinutes != null">
			and expire_dt &gt; sysdate
			</if>
		</where>
	</select>

	<update id="saveAuth">
		/* auth.saveAuth */
		merge into shfda.tb_auth
		using dual
		on (auth_id = #{authId})

		when not matched then
		insert
		(
			 auth_id
			, chat_room_uid
			, cstm_uid
			, coc_id
			, auth_type
			, auth_position
			, create_dt
			, expire_dt
		)
		values
		(
			 shfda.seq_auth_id.nextval
			, #{chatRoomUid}
			, #{cstmUid}
			, #{cocId}
			, #{authType}
			, #{authPosition}
			, sysdate
			, sysdate + ${expiredMinutes} / (24 * 60)
		)
	
		when matched then
		update
		set
			expire_dt = sysdate + ${expiredMinutes} / (24 * 60)
			, coc_id = #{cocId}
			, auth_type = #{authType}
			, auth_position = #{authPosition}
		where
			auth_id = #{authId}
	</update>

	<update id="deleteAuth">
		/* auth.deleteAuth */
		delete from shfda.tb_auth
		where
			<if test="authId != null">
			auth_id = #{authId}
			</if>
			<if test="chatRoomUid != null">
			chat_room_uid = #{chatRoomUid}
			</if>
	</update>
	
	<select id="selectCheckAuth" resultType="int">
		select 
		    count(*) as cnt 
		from 
		    shfda.tb_auth a left join shfda.tb_chat_room b on ( a.CHAT_ROOM_UID = b.CHAT_ROOM_UID)
		where   
		    b.CSTM_LINK_DIV_CD = 'B'
		    and a.chat_room_uid= #{chatRoomUid}
	</select> 
</mapper>
